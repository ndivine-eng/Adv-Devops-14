name: CD Pipeline - Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_infrastructure:
        description: "Deploy infrastructure (will incur costs)"
        required: false
        default: "false"
        type: boolean

env:
  AZURE_RESOURCE_GROUP: "rg-todo-devops"
  NODE_VERSION: "18"
  TERRAFORM_VERSION: "1.6.0"
  APP_WORKING_DIR: "todo-devops"
  TF_WORKING_DIR: "todo-devops/terraform/azure"

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ---- CI-style checks: Node app ----
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: ${{ env.APP_WORKING_DIR }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ env.APP_WORKING_DIR }}

      - name: Run tests one more time
        run: npm test
        working-directory: ${{ env.APP_WORKING_DIR }}

      # --- Security Scanning Steps ---
      - name: Trivy scan filesystem (app)
        uses: aquasecurity/trivy-action@v0.14.0
        with:
          scan-type: fs
          scan-ref: ${{ env.APP_WORKING_DIR }}
          format: table
          exit-code: 1
          severity: CRITICAL,HIGH

      - name: tfsec scan Terraform
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          working-directory: ${{ env.TF_WORKING_DIR }}
      # --- End Security Scanning Steps ---

      # ---- Azure & Terraform ----
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          TF_VAR_azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          TF_VAR_admin_password: ${{ secrets.ADMIN_PASSWORD }}
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}

      - name: Terraform Plan
        run: terraform plan -out=tfplan
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          TF_VAR_azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          TF_VAR_admin_password: ${{ secrets.ADMIN_PASSWORD }}
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}

      - name: Terraform Apply (Infrastructure)
        if: github.event.inputs.deploy_infrastructure == 'true' || github.event_name == 'push'
        run: terraform apply -auto-approve tfplan
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Get Infrastructure Outputs
        id: terraform-output
        run: |
          echo "acr_name=$(terraform output -raw acr_name)" >> $GITHUB_OUTPUT
          echo "acr_login_server=$(terraform output -raw acr_login_server)" >> $GITHUB_OUTPUT
          echo "app_public_ip=$(terraform output -raw app_public_ip)" >> $GITHUB_OUTPUT
          echo "bastion_public_ip=$(terraform output -raw bastion_public_ip)" >> $GITHUB_OUTPUT
        working-directory: ${{ env.TF_WORKING_DIR }}

      # ---- Build and push Docker image to ACR ----
      - name: Build and Push to ACR
        run: |
          az acr build \
            --registry  ${{ steps.terraform-output.outputs.acr_name }} \
            --image todo-app:${{ github.sha }} \
            --image todo-app:latest \
            ${{ env.APP_WORKING_DIR }}

      # ---- Ansible deployment ----
      - name: Setup Python for Ansible
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: |
          pip install ansible docker

      - name: Deploy Application with Ansible
        run: |
          # Get ACR credentials
          ACR_USERNAME=$(az acr credential show --name ${{ steps.terraform-output.outputs.acr_name }} --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name ${{ steps.terraform-output.outputs.acr_name }} --query passwords[0].value -o tsv)

          ansible-playbook -i ${{ env.APP_WORKING_DIR }}/ansible/inventory.ini ${{ env.APP_WORKING_DIR }}/ansible/playbook.yml \
            --extra-vars "acr_login_server=${{ steps.terraform-output.outputs.acr_login_server }}" \
            --extra-vars "acr_username=$ACR_USERNAME" \
            --extra-vars "acr_password=$ACR_PASSWORD" \
            --extra-vars "db_password=${{ secrets.DB_PASSWORD }}"

      - name: Application Health Check
        run: |
          sleep 30
          curl -f "http://${{ steps.terraform-output.outputs.app_public_ip }}/health" || exit 1
          echo "‚úÖ Application is healthy and running!"

      - name: Deployment Summary
        run: |
          echo "üéâ Deployment completed successfully!"
          echo "üì± Application URL: http://${{ steps.terraform-output.outputs.app_public_ip }}"
          echo "üöÄ Image: ${{ steps.terraform-output.outputs.acr_login_server }}/todo-app:${{ github.sha }}"
          echo "üíæ Database: Azure PostgreSQL Flexible Server"
          echo "üîê Bastion Host: ${{ steps.terraform-output.outputs.bastion_public_ip }}"
